
channel c_in, c_out. 

param N.

(******************** 
  MAC
********************)

type mkeyseed [fixed, large].
type mkey [bounded].
type macinput.
(* type macres. *)
proba Pmac.

expand UF_CMA_mac(mkeyseed, mkey, bitstring, bitstring, mkgen, HMAC_sha1, HMAC_sha1_check, Pmac).

forall m: bitstring, k: mkey, r: bitstring;
  ((HMAC_sha1(m, k)) = r) = HMAC_sha1_check(m, k, r).

(******************** 
  <Query>
********************)
 
event client_begin(bitstring).
event client_accept(bitstring, bitstring).
event server_reply(bitstring, bitstring).

query x: bitstring, y:bitstring;
  event client_accept(x, y) ==> server_reply(x, y).

query x: bitstring, y:bitstring;
  event server_reply(x, y) ==> client_begin(x).

(*
query x: bitstring, y:bitstring;
  event client_accept(x, y).
*)

(******************** 
  <Model>
********************)

let A = 0 . let B = 0 .

(******************** 
  <Environment>
********************)

process
! N (
  in(c_in, (request: bitstring, response: bitstring));
  new keyseed: mkeyseed; 
  let keyAB = mkgen(keyseed) in
  out(c_out, ());
  ((! N A) | (! N B))
)
