
free c.

(******************** 
  Crypto
********************)

fun HMAC_sha1/2.


(******************** 
  Constants 
********************)

(******************** 
  Concatenation and Parsing 
********************)

data conc1/2.

data conc2/1.

reduc 
  parse3(conc1(x0, x1)) = x0;
  parse3(conc2(x0)) = x0.
reduc 
  parse4(conc1(x0, x1)) = x1.

(******************** 
  <Query>
********************)

query ev:server_recv(x) ==> ev:client_send(x).
query ev:server_recv(x).



(*************************** 
  Model 
***************************)

let A = 
event client_send(payload);
let msg1 = conc1(payload, HMAC_sha1(conc2(payload), key)) in
out(c, msg1); 0.

let B = 
in(c, msg1);
in(c, msg2);
let var1 = parse4(msg2) in
let hash1 = HMAC_sha1(conc2(parse3(msg2)), key) in
if hash1 = var1 then 
event server_recv(parse3(msg2)); 0.

(******************** 
  <Environment>
********************)

process !
  new key;
  in(c, payload);
  (!A | !B)
